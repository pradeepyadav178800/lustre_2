{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "SAS Application Name": {
            "minLength": 2,
            "maxLength": 5,
            "type": "String",
            "metadata": {
                "description": "This tag will be used as a prefix for the hostname of the SAS servers and Azure resources"
            }
        },
        "Admin Ingress Location": {
            "type": "String",
            "metadata": {
                "description": "Allow inbound SSH traffic to the Ansible Controller-Bastion Host from this CIDR block or IP address range. Must be a valid IP or CIDR range of the form x.x.x.x or x.x.x.x/x"
            }
        },
        "Vnet Address CIDR": {
            "defaultValue": "10.10.0.0/16",
            "type": "String",
            "metadata": {
                "description": "Virtual Network CIDR, ex. 10.10.0.0/16"
            }
        },
        "Ansible-Bastion PublicSubnet CIDR": {
            "defaultValue": "10.10.1.0/24",
            "type": "String",
            "metadata": {
                "description": "Virtual Network Public Subnet CIDR, ex. 10.10.1.0/24 which should allign with VNET CIDR"
            }
        },
        "SAS94 PrivateSubnet CIDR": {
            "defaultValue": "10.10.2.0/24",
            "type": "String",
            "metadata": {
                "description": "Virtual Network Private Subnet CIDR, ex. 10.10.2.0/24 which should allign with VNET CIDR"
            }
        },
        "SAS94 Meta VM Size": {
            "defaultValue": "Standard_D4s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the Meta VM.The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "SAS94 Mid VM Size": {
            "defaultValue": "Standard_E8s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the Mid VM. The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "SAS94 Grid VM Size": {
            "defaultValue": "Standard_E8s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the Grid VM.The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "SAS94 Grid Node VM Size": {
            "defaultValue": "Standard_D4s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the Grid Node VM.The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "Number of SAS94 Grid Nodes": {
            "defaultValue": 1,
            "minValue": 1,
            "maxValue": 100,
            "type": "Int",
            "metadata": {
                "description": "The number of SAS Grid Node to create."
            }
        },
        "SAS External Password": {
            "minLength": 12,
            "maxLength": 14,
            "type": "SecureString",
            "metadata": {
                "description": "Password for RDP login & SAS admin account in SAS servers(SAS94:sasadm,SAS Viya:sas)"
            }
        },
        "SAS Internal Password": {
            "minLength": 8,
            "maxLength": 15,
            "type": "SecureString",
            "metadata": {
                "description": "Password for SAS Internal Accounts(SAS94: Metadata & WIP, SAS Viya:cas)"
            }
        },
        "Lustre PrivateSubnet CIDR": {
            "type": "String",
            "defaultValue": "10.10.3.0/24",
            "metadata": {
                "description": "Virtual Network Private Subnet CIDR, ex. 10.10.3.0/24 which should allign with VNET CIDR"
            }
        },
        "Lustre OSS Node VM Size": {
            "defaultValue": "Standard_E16s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the lustre OSS Node VM."
            }
        },
        "Number of Lustre OSS Nodes": {
            "type": "int",
            "defaultValue": 1,
            "minValue": 1,
            "maxValue": 100,
            "metadata": {
                "description": "Number of Lustre Nodes to be created"
            }
        },
        "SAS94 Lustre Data Storage": {
            "defaultValue": 100,
            "minValue": 100,
            "maxValue": 32767,
            "type": "Int",
            "metadata": {
                "description": "The SAS data volume size for SAS 94 Gird. The total storage will be the multiple of OSS nodes and storage (i.e. Number of Lustre OSS Nodes * SAS94 Lustre Data Storage)"
            }
        },
        "Viya PrivateSubnet CIDR": {
            "type": "String",
            "defaultValue": "10.10.4.0/24",
            "metadata": {
                "description": "Virtual Network Private Subnet CIDR, ex. 10.10.3.0/24 which should allign with VNET CIDR"
            }
        },
        "Viya Microservices VM Size": {
            "defaultValue": "Standard_E16s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the MicroServices VM. The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "Viya SPRE VM Size": {
            "defaultValue": "Standard_E8s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the SPRE VM. The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "Viya CAS Controller VM Size": {
            "defaultValue": "Standard_E8s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the CASController VM. The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disk. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "Viya CAS Worker VM Size": {
            "defaultValue": "Standard_E8s_v3",
            "type": "String",
            "metadata": {
                "description": "This is the SKU for the CAS Worker VM. The default SKU value represents the minimum recommended size for system stability in most SAS software license sets. The selected SKU must support premium disks. For details: https://azure.microsoft.com/en-in/pricing/details/virtual-machines/red-hat/"
            }
        },
        "Number Of Viya CAS Nodes": {
            "defaultValue": 1,
            "minValue": 1,
            "maxValue": 100,
            "type": "Int",
            "metadata": {
                "description": "The number of CAS Worker Nodes to create."
            }
        },
        "SAS Viya Data Storage": {
            "defaultValue": 100,
            "minValue": 100,
            "maxValue": 32767,
            "type": "Int",
            "metadata": {
                "description": "The SAS data volume size for SAS Viya."
            }
        },
        "Storage Account Name": {
            "type": "String",
            "metadata": {
                "description": "Storage Account Name where SAS Depot is located"
            }
        },
        "Storage Account Key": {
            "type": "SecureString",
            "metadata": {
                "description": "Storage Account Key"
            }
        },
        "File Share Name": {
            "type": "String",
            "metadata": {
                "description": "File Share Name where SASDepot is located"
            }
        },
        "SASDepot Folder": {
            "type": "String",
            "metadata": {
                "description": "Folder Name in Azure File share where SAS94 depot is located"
            }
        },
        "Viyarepo Folder": {
            "type": "String",
            "metadata": {
                "description": "Folder Name in Azure File share where SAS Viya Repo is located"
            }
        },
        "SAS94 Server license file": {
            "type": "String",
            "metadata": {
                "description": "Name of SAS Application Server License file.You will find this file inside the SAS Software Depot. It should be inside the folder sid_file."
            }
        },
        "SAS94 Grid license file": {
            "type": "String",
            "metadata": {
                "description": "Name of SAS Application Server License file.You will find this file inside the SAS Software Depot. It should be inside the folder sid_file."
            }
        },
        "SAS LSF license file": {
            "type": "String",
            "metadata": {
                "description": "Name of SAS Application Server License file.You will find this file inside the SAS Software Depot. It should be inside the folder sid_file."
            }
        },
        "SSHPublicKey": {
            "type": "String",
            "metadata": {
                "description": "The full ssh public key that will be added to the servers."
            }
        },
        "KeyVault Owner ID": {
            "type": "string",
            "metadata": {
                "description": "Key Vault Owner Object ID,Specifies the object ID of a user, service principal or security group in the Azure Active Directory tenant for the vault.Get it by using Get-AzADUser or Get-AzADServicePrincipal cmdlets. e.g.In Azure Cloud PowerShell type PS> Get-AzADUser -UserPrincipalName user@domain.com | grep Id"
            }
        },
        "Location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Azure Resources location,where all the SAS 94 and Viya reosurce should be created. e.g. servers, disks, ip's etc."
            }
        },
        "_artifactsLocation": {
			"defaultValue": "https://raw.githubusercontent.com/corecompete/sas94grid-viya/master/",
            "type": "String",
            "metadata": {
                "description": "For a standard deployment, keep the default.  The https URL to the base of the deployment files in Microsoft Azure. If a SAS key is needed, please do not include the SAS key in the URL. Instead, add the part after and include the question mark to the _artifactsLocationSasToken variable. ex. https://(STORAGE_ACCOUNT).file.core.windows.net/(SHARE_NAME)/(SUBDIRECTORY_NAME)/"
            }
        }
    },
    "variables": {
        "_artifactsLocationSasToken": "",
        "access_policy_template": "[concat(parameters('_artifactsLocation'),'nestedtemplates/access_policy.json', variables('_artifactsLocationSasToken'))]",
        "agent_startup_gridnodes_sh": "[concat(parameters('_artifactsLocation'),'scripts/agent_startup_gridnodes.sh', variables('_artifactsLocationSasToken'))]",
        "ansible_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('ansible_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "ansible_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('ansible_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "ansible_pub_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('ansible_vm_name'),'_pub_nic_',variables('resourceGroupUniqueString'))]",
        "ansible_ssl_copy_sh": "[concat(parameters('_artifactsLocation'),'scripts/ansible_ssl.sh', variables('_artifactsLocationSasToken'))]",
        "ansible_startup_script_sh": "[concat(parameters('_artifactsLocation'),'scripts/ansible_setup.sh', variables('_artifactsLocationSasToken'))]",
        "ansible_vm_name": "ansible",
        "ansible_vm_size": "Standard_DS2_v2",
        "cascontroller_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('cascontroller_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "cascontroller_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('cascontroller_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "Cascontroller_vm_name": "cascontroller",
        "casworker_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('casworker_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "casworker_vm_name": "casworker",
        "certificatesPermissions": [
            "import",
            "get",
            "list"
        ],
        "custom_data_cas": "#cloud-config\n mounts:\n   - [ ephemeral0, /cascache]",
        "custom_data_sas": "#cloud-config\n mounts:\n   - [ ephemeral0, /saswork]",
        "diagnostic_storagegroup_name": "[toLower(concat(parameters('SAS Application Name'),'diag', variables('resourceGroupUniqueString')))]",
        "disk_size_10": "[div(parameters('SAS94 Lustre Data Storage'), 10)]",
        "domain_name": "internal.cloudapp.net",
        "enabledForDeployment": true,
        "enabledForDiskEncryption": false,
        "enabledForTemplateDeployment": true,
        "enableSoftDelete": false,
        "envmanager_setup_sh": "[concat(parameters('_artifactsLocation'),'scripts/envmanager_agents_setup.sh', variables('_artifactsLocationSasToken'))]",
        "grid_binary_copy_sh": "[concat(parameters('_artifactsLocation'),'scripts/grid_sas_home_copy.sh', variables('_artifactsLocationSasToken'))]",
        "grid_config_sh": "[concat(parameters('_artifactsLocation'),'scripts/grid_config.sh', variables('_artifactsLocationSasToken'))]",
        "grid_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/grid_install.sh', variables('_artifactsLocationSasToken'))]",
        "grid_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('grid_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "grid_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('grid_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "grid_vm_name": "grid",
        "gridnode_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('gridnode_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "gridnode_vm_name": "gridnode",
        "key_vault_name": "[concat(parameters('SAS Application Name'), 'kv-',variables('resourceGroupUniqueString'))]",
        "key_vault_secretname_pubkey": "ansible-pubkey",
        "key_vault_secretname_pvtkey": "ansible-pvtkey",
        "key_vault_secretname_sasext": "sasextpw",
        "key_vault_secretname_sasinst": "sasintpw",
        "key_vault_secretname_stgacc": "stgacckey",
        "keysPermissions": [
            "get",
            "list",
            "import"
        ],
        "linux_extension_template": "[concat(parameters('_artifactsLocation'),'nestedtemplates/vm_linux_extension.json', variables('_artifactsLocationSasToken'))]",
        "lustre_pre_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/lustre_pre_install.sh', variables('_artifactsLocationSasToken'))]",
        "LustreVmSize": "Standard_F4s_v2",
        "mdt_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('mdt_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "mdt_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('mdt_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "mdt_pkg_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/mdt_pkg_install.sh', variables('_artifactsLocationSasToken'))]",
        "mdt_vm_name": "mdt",
        "meta_config_sh": "[concat(parameters('_artifactsLocation'),'scripts/meta_config.sh', variables('_artifactsLocationSasToken'))]",
        "meta_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/meta_install.sh', variables('_artifactsLocationSasToken'))]",
        "meta_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('meta_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "meta_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('meta_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "meta_vm_name": "meta",
        "mgt_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('mgt_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "mgt_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('mgt_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "mgt_pkg_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/mgt_pkg_install.sh', variables('_artifactsLocationSasToken'))]",
        "mgt_vm_name": "mgt",
        "mgt_wait_sh": "[concat(parameters('_artifactsLocation'),'scripts/mgt_wait.sh', variables('_artifactsLocationSasToken'))]",
        "microservices_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('microservices_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "microservices_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('microservices_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "microservices_vm_name": "microservices",
        "mid_config_sh": "[concat(parameters('_artifactsLocation'),'scripts/mid_config.sh', variables('_artifactsLocationSasToken'))]",
        "mid_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/mid_install.sh', variables('_artifactsLocationSasToken'))]",
        "mid_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('mid_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "mid_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('mid_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "mid_vm_name": "mid",
        "oss_node_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/oss_node_install.sh', variables('_artifactsLocationSasToken'))]",
        "oss_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('oss_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "oss_vm_name": "oss",
        "PrimaryUserName": "vmuser",
        "pss_install_master.sh": "[concat(parameters('_artifactsLocation'),'scripts/pss_install_master.sh', variables('_artifactsLocationSasToken'))]",
        "pss_install_node_sh": "[concat(parameters('_artifactsLocation'),'scripts/pss_install_nodes.sh', variables('_artifactsLocationSasToken'))]",
        "pub_sub_nw_sg": "[concat(parameters('SAS Application Name'), '_subnt_pub1_nsg_',variables('resourceGroupUniqueString'))]",
        "pvt_sub_nw_sg": "[concat(parameters('SAS Application Name'), '_subnt_pvt1_nsg_',variables('resourceGroupUniqueString'))]",
        "rdp_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('rdp_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "rdp_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('rdp_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "rdp_os_version": "2012-R2-Datacenter",
        "rdp_vm_name": "rdp",
        "rdp_vm_size": "Standard_DS2_v2",
        "reader_role": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
        "resourceGroupUniqueString": "[uniqueString(resourceGroup().id)]",
        "role_assignment_template": "[concat(parameters('_artifactsLocation'),'nestedtemplates/role_assignments.json', variables('_artifactsLocationSasToken'))]",
        "sas_opt_sas_disk_size": 128,
        "sas_osdisk_size": 128,
        "sas_viya_backup_size": 100,
        "lustre_osdisk_size": 64,
        "lustre_opt_sas_disk_size": 128,
        "sasclients_power_shell_script": "[concat(parameters('_artifactsLocation'),'scripts/sas_clients_install.ps1', variables('_artifactsLocationSasToken'))]",
        "sasgrid_prereq_sh": "[concat(parameters('_artifactsLocation'),'scripts/sasappgrid_prereq.sh', variables('_artifactsLocationSasToken'))]",
        "secretsPermissions": [
            "get",
            "list",
            "set"
        ],
        "skuName": "standard",
        "spre_nw_interface": "[concat(parameters('SAS Application Name'),'_',variables('spre_vm_name'),'_nic_',variables('resourceGroupUniqueString'))]",
        "spre_nw_sg": "[concat(parameters('SAS Application Name'),'_',variables('spre_vm_name'),'_nsg_',variables('resourceGroupUniqueString'))]",
        "spre_vm_name": "spre",
        "tenantId": "[subscription().tenantId]",
        "viya_ark_sh": "[concat(parameters('_artifactsLocation'),'scripts/viya_ark.sh', variables('_artifactsLocationSasToken'))]",
        "viya_install_sh": "[concat(parameters('_artifactsLocation'),'scripts/viyainstall.sh', variables('_artifactsLocationSasToken'))]",
        "viya_startup_script_sh": "[concat(parameters('_artifactsLocation'),'scripts/viya_prereq.sh', variables('_artifactsLocationSasToken'))]",
        "vnet_lustre_pvt_subnt": "[concat(parameters('SAS Application Name'), '_vnet_pvt2_subnt_',variables('resourceGroupUniqueString'))]",
        "vnet_name": "[concat(parameters('SAS Application Name'),'_vnet_',variables('resourceGroupUniqueString'))]",
        "vnet_pub_subnt": "[concat(parameters('SAS Application Name'),'_vnet_pub1_subnt_',variables('resourceGroupUniqueString'))]",
        "vnet_pvt_subnt": "[concat(parameters('SAS Application Name'), '_vnet_pvt1_subnt_',variables('resourceGroupUniqueString'))]",
        "vnet_viya_pvt_subnt": "[concat(parameters('SAS Application Name'), '_vnet_pvt3_subnt_',variables('resourceGroupUniqueString'))]",
        "windows_extension_template": "[concat(parameters('_artifactsLocation'),'nestedtemplates/vm_windows_extension.json', variables('_artifactsLocationSasToken'))]",
        "ppg_name": "[concat(parameters('SAS Application Name'),'_ppg_',variables('resourceGroupUniqueString'))]",
        "sas94vm_tags": {
            "Application": "[parameters('SAS Application Name')]",
            "Component": "SAS94NonGrid"
        },
        "sasviyavm_tags": {
            "Application": "[parameters('SAS Application Name')]",
            "Component": "SASViya"
        },
        "lustrevm_tags": {
            "Application": "[parameters('SAS Application Name')]",
            "Component": "Lustre"
        }
    },
    "resources": [
        {
            "apiVersion": "2019-12-01",
            "type": "Microsoft.Compute/proximityPlacementGroups",
            "name": "[variables('ppg_name')]",
            "location": "[parameters('Location')]"
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-06-01",
            "name": "[variables('vnet_name')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups',variables('pub_sub_nw_sg'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups',variables('pvt_sub_nw_sg'))]"
            ],
            "location": "[parameters('Location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('Vnet Address CIDR')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('vnet_pvt_subnt')]",
                        "properties": {
                            "addressPrefix": "[parameters('SAS94 PrivateSubnet CIDR')]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('pvt_sub_nw_sg'))]"
                            }
                        }
                    },
                    {
                        "name": "[variables('vnet_lustre_pvt_subnt')]",
                        "properties": {
                            "addressPrefix": "[parameters('Lustre PrivateSubnet CIDR')]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('pvt_sub_nw_sg'))]"
                            }
                        }
                    },
                    {
                        "name": "[variables('vnet_viya_pvt_subnt')]",
                        "properties": {
                            "addressPrefix": "[parameters('Viya PrivateSubnet CIDR')]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('pvt_sub_nw_sg'))]"
                            }
                        }
                    },
                    {
                        "name": "[variables('vnet_pub_subnt')]",
                        "properties": {
                            "addressPrefix": "[parameters('Ansible-Bastion PublicSubnet CIDR')]",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('pub_sub_nw_sg'))]"
                            }
                        }
                    }
                ],
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('pub_sub_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "allow-ssh",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "22",
                            "sourceAddressPrefix": "[parameters('Admin Ingress Location')]",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Inbound"
                        }
                    }
                ],
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "80,443",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('pvt_sub_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "80,443",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults",
            "name": "[variables('key_vault_name')]",
            "apiVersion": "2019-09-01",
            "location": "[parameters('Location')]",
            "properties": {
                "enabledForDeployment": "[variables('enabledForDeployment')]",
                "enabledForDiskEncryption": "[variables('enabledForDiskEncryption')]",
                "enabledForTemplateDeployment": "[variables('enabledForTemplateDeployment')]",
                "enableSoftDelete": "[variables('enableSoftDelete')]",
                "tenantId": "[variables('tenantId')]",
                "accessPolicies": [
                    {
                        "objectId": "[parameters('KeyVault Owner ID')]",
                        "tenantId": "[variables('tenantId')]",
                        "permissions": {
                            "keys": "[variables('keysPermissions')]",
                            "secrets": "[variables('secretsPermissions')]"
                        }
                    }
                ],
                "sku": {
                    "name": "[variables('skuName')]",
                    "family": "A"
                },
                "networkAcls": {
                    "defaultAction": "Allow",
                    "bypass": "AzureServices"
                }
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "name": "[concat(variables('key_vault_name'), '/', variables('key_vault_secretname_sasinst'))]",
            "apiVersion": "2019-09-01",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]"
            ],
            "properties": {
                "value": "[parameters('SAS Internal Password')]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "name": "[concat(variables('key_vault_name'), '/', variables('key_vault_secretname_sasext'))]",
            "apiVersion": "2019-09-01",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]"
            ],
            "properties": {
                "value": "[parameters('SAS External Password')]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('key_vault_name'), '/', variables('key_vault_secretname_stgacc'))]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]"
            ],
            "properties": {
                "value": "[parameters('Storage Account Key')]"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-04-01",
            "name": "[variables('diagnostic_storagegroup_name')]",
            "location": "[parameters('Location')]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": false,
                "encryption": {
                    "services": {
                        "file": {
                            "enabled": true
                        },
                        "blob": {
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('ansible_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "allow-ssh",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "22",
                            "sourceAddressPrefix": "[parameters('Admin Ingress Location')]",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Inbound"
                        }
                    }
                ],
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "80,443",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('microservices_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('spre_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('cascontroller_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('casworker_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('meta_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('mid_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('gridnode_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('mgt_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('mdt_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('oss_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('grid_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('rdp_nw_sg')]",
            "location": "[parameters('Location')]",
            "properties": {
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "properties": {
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "properties": {
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "properties": {
                            "description": "Allow outbound traffic from all VMs to the Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound"
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "properties": {
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('ansible_pub_nw_interface')]",
            "location": "[parameters('Location')]",
            "sku": {
                "name": "Basic",
                "tier": "Regional"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('ansible_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('ansible_pub_nw_interface'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('ansible_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('ansible_pub_nw_interface'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_pub_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('ansible_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('ansible_vm_name')]",
            "location": "[parameters('Location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('ansible_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]",
                "[resourceId('Microsoft.KeyVault/vaults',variables('key_vault_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('ansible_vm_size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('ansible_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": 64
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('ansible_vm_name'),'-playbook')]",
                            "diskSizeGB": 50,
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('ansible_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('ansible_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "AnsibleRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('ansible_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid(variables('ansible_vm_name'),resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('ansible_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "AnsibleAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('ansible_vm_name'))]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('ansible_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-AnsibleHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('ansible_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','AnsibleAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./ansible_setup.sh',' ',parameters('Storage Account Name'),' ',variables('key_vault_secretname_stgacc'),' ',parameters('File Share Name'),' ',parameters('Viyarepo Folder'),' ',parameters('SAS Application Name'),' ',variables('domain_name'),' ',variables('ansible_vm_name'),' ',variables('microservices_vm_name'),' ',variables('cascontroller_vm_name'),' ',variables('spre_vm_name'),' ',variables('casworker_vm_name'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',parameters('Number Of Viya CAS Nodes'),' ',variables('mid_vm_name'),' ',parameters('_artifactsLocation'),' ',variables('grid_vm_name'),' ',variables('meta_vm_name'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('ansible_startup_script_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-AnsibleSSLCopy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('ansible_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-MetaInstall')]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-GridPSSInstall')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;./ansible_ssl.sh 2>&1 | tee /var/log/sas/install/runPhase2AnsibleSSLCopy.log;')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('ansible_ssl_copy_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase3-ViyaInstallpart1",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-AnsibleHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase2-MicroServicesViyaARK')]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase2-SpreViyaARK')]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase2-CASControllerViyaARK')]",
                "casworkerviyaarkcopy"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viyainstall.sh',' ', '1',' ','2>&1 | tee /var/log/sas/install/runPhase3_viyainstallpart1.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase4-ViyaInstallpart2",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'Phase3-ViyaInstallpart1')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viyainstall.sh',' ', '2',' ','2>&1 | tee /var/log/sas/install/runPhase4_viyainstallpart2.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase5-ViyaInstallpart3",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'Phase4-ViyaInstallpart2')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viyainstall.sh',' ', '3',' ','2>&1 | tee /var/log/sas/install/runPhase5_viyainstallpart3.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase6-ViyaPostInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'Phase5-ViyaInstallpart3')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viyainstall.sh',' ', '4',' ','2>&1 | tee /var/log/sas/install/runPhase6_viyapostinstall.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('rdp_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups',variables('rdp_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('rdp_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('rdp_vm_name')]",
            "location": "[parameters('Location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('rdp_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('rdp_vm_size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "[variables('rdp_os_version')]",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                    }
                },
                "osProfile": {
                    "computerName": "[variables('rdp_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "adminPassword": "[parameters('SAS External Password')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('rdp_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-SASClientInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('rdp_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('windows_extension_template')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('rdp_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('powershell -ExecutionPolicy Unrestricted -File sas_clients_install.ps1 ','-stg_acc_name ',parameters('Storage Account Name'),' -stg_key ',parameters('Storage Account Key'),' -file_share_name ',parameters('File Share Name'),' -depot_folder_name ',parameters('SASDepot Folder'),' -clients_sid ',parameters('SAS94 Server license file'),' -app_name ',parameters('SAS Application Name'),' -mid_name ',variables('mid_vm_name'),' -domain_name ',variables('domain_name'),' -artifact_loc ',parameters('_artifactsLocation'))]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('sasclients_power_shell_script')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('meta_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('meta_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('meta_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('meta_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sas94vm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('meta_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('SAS94 Meta VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('meta_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('meta_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('meta_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('meta_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "MetaRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('meta_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid('Meta',resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('meta_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "MetaAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('meta_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','AnsibleAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('meta_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-MetaHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('meta_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'MetaAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('meta_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./sasappgrid_prereq.sh',' ',parameters('SAS Application Name'),' ',parameters('SASDepot Folder'),' ',parameters('File Share Name'),' ',parameters('Storage Account Name'),' ',variables('domain_name'),' ',parameters('Location'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',variables('mid_vm_name'),' ',variables('meta_vm_name'),' ',variables('grid_vm_name'),' ',parameters('SAS94 Server license file'),' ',parameters('SAS94 Grid license file'),' ',parameters('SAS LSF license file'),' ',variables('key_vault_secretname_stgacc'),' ','meta',' ',parameters('_artifactsLocation'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('sasgrid_prereq_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-MetaInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('meta_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-MetaHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('meta_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./meta_install.sh 2>&1 | tee /var/log/sas/install/meta_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('meta_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase3-MetaConfig",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('meta_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-MetaInstall')]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-AnsibleSSLCopy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('meta_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./meta_config.sh 2>&1 | tee /var/log/sas/install/meta_config.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('meta_config_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('grid_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('grid_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('grid_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('grid_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sas94vm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('grid_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('SAS94 Grid VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('grid_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('grid_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('grid_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "customData": "[base64(variables('custom_data_sas'))]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('grid_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "GridRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('grid_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid('Sasgrid',resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('grid_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "GridAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('grid_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','MetaAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('grid_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-GridHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('grid_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'GridAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('grid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./sasappgrid_prereq.sh',' ',parameters('SAS Application Name'),' ',parameters('SASDepot Folder'),' ',parameters('File Share Name'),' ',parameters('Storage Account Name'),' ',variables('domain_name'),' ',parameters('Location'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',variables('mid_vm_name'),' ',variables('meta_vm_name'),' ',variables('grid_vm_name'),' ',parameters('SAS94 Server license file'),' ',parameters('SAS94 Grid license file'),' ',parameters('SAS LSF license file'),' ',variables('key_vault_secretname_stgacc'),' ','grid',' ',parameters('_artifactsLocation'),' ',parameters('Number of SAS94 Grid Nodes'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('sasgrid_prereq_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-GridPSSInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments','Phase1-GridHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-MdtInstall')]",
                "ossnodecopy"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('grid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./pss_install_master.sh 2>&1 | tee /var/log/sas/install/pss_install_master.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('pss_install_master.sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase3-GridInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments','Phase2-GridPSSInstall')]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('grid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./grid_install.sh 2>&1 | tee /var/log/sas/install/grid_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('grid_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase4-GridBinaryCopy",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments','Phase3-GridInstall')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('grid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./grid_sas_home_copy.sh 2>&1 | tee /var/log//sas/install/grid_sas_home_copy.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('grid_binary_copy_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase5-GridConfig",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments','Phase4-GridBinaryCopy')]",
                "[resourceId('Microsoft.Resources/deployments','Phase3-MetaConfig')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('grid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./grid_config.sh 2>&1 | tee /var/log/sas/install/grid-config.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('grid_config_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase6-GridEnvMgrSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments','Phase5-GridConfig')]",
                "[resourceId('Microsoft.Resources/deployments','Phase3-MidConfig')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('grid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./envmanager_agents_setup.sh 2>&1 | tee /var/log/sas/install/envmgr_setup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('envmanager_setup_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('mid_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mid_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mid_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('mid_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sas94vm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('mid_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('SAS94 Mid VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('mid_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('mid_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('mid_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('mid_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "MidRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('mid_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid('Mid',resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('mid_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "MidAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('mid_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','GridAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('mid_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-MidHostsetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('mid_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'MidAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./sasappgrid_prereq.sh',' ',parameters('SAS Application Name'),' ',parameters('SASDepot Folder'),' ',parameters('File Share Name'),' ',parameters('Storage Account Name'),' ',variables('domain_name'),' ',parameters('Location'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',variables('mid_vm_name'),' ',variables('meta_vm_name'),' ',variables('grid_vm_name'),' ',parameters('SAS94 Server license file'),' ',parameters('SAS94 Grid license file'),' ',parameters('SAS LSF license file'),' ',variables('key_vault_secretname_stgacc'),' ','mid',' ',parameters('_artifactsLocation'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('sasgrid_prereq_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-MidInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('mid_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-MidHostsetup')]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-GridPSSInstall')]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./mid_install.sh 2>&1 | tee /var/log/sas/install/mid_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('mid_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase3-MidConfig",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('mid_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-MidInstall')]",
                "[resourceId('Microsoft.Resources/deployments','Phase5-GridConfig')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mid_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./mid_config.sh 2>&1 | tee /var/log/sas/install/mid_config.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('mid_config_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[concat(parameters('SAS Application Name'),'_',variables('gridnode_vm_name'), copyIndex(1),'_nic_',variables('resourceGroupUniqueString'))]",
            "copy": {
                "name": "sasnodeNICcopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('gridnode_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('gridnode_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[concat(variables('gridnode_vm_name'), copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "location": "[parameters('Location')]",
            "tags": "[variables('sas94vm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('SAS Application Name'),'_',variables('gridnode_vm_name'), copyIndex(1),'_nic_',variables('resourceGroupUniqueString')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('SAS94 Grid Node VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('gridnode_vm_name'),copyIndex(1),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('gridnode_vm_name'),copyIndex(1),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[concat(variables('gridnode_vm_name'), copyIndex(1))]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "customData": "[base64(variables('custom_data_sas'))]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('SAS Application Name'),'_',variables('gridnode_vm_name'), copyIndex(1),'_nic_',variables('resourceGroupUniqueString')))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('GridNode-RoleAssignment', copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('gridnode_vm_name'), copyIndex(1)))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid(concat(variables('gridnode_vm_name'), copyIndex(1)),resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',concat(variables('gridnode_vm_name'), copyIndex(1))),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('GridNode-AccessPolicy', copyIndex(1))]",
            "copy": {
                "mode": "serial",
                "batchSize": 1,
                "name": "sasgridnodecopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('gridnode_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Resources/deployments','MidAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',concat(variables('gridnode_vm_name'), copyIndex(1))),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase1-GridNodeHostSetup', copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',concat(variables('gridnode_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Resources/deployments', concat('GridNode-AccessPolicy', copyIndex(1)))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('gridnode_vm_name'), copyIndex(1))]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./sasappgrid_prereq.sh',' ',parameters('SAS Application Name'),' ',parameters('SASDepot Folder'),' ',parameters('File Share Name'),' ',parameters('Storage Account Name'),' ',variables('domain_name'),' ',parameters('Location'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',variables('mid_vm_name'),' ',variables('meta_vm_name'),' ',variables('grid_vm_name'),' ',parameters('SAS94 Server license file'),' ',parameters('SAS94 Grid Node VM Size'),' ',parameters('SAS LSF license file'),' ',variables('key_vault_secretname_stgacc'),' ','gridnode',' ',parameters('_artifactsLocation'),' ',parameters('Number of SAS94 Grid Nodes'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('sasgrid_prereq_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase2-GridNodePSSInstall', copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',concat(variables('gridnode_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Resources/deployments',concat('Phase1-GridNodeHostSetup', copyIndex(1)))]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-GridPSSInstall')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('gridnode_vm_name'), copyIndex(1))]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./pss_install_nodes.sh 2>&1 | tee /var/log/pss_install_nodes.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('pss_install_node_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase3-GridNodeEnvStartup', copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of SAS94 Grid Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',concat(variables('gridnode_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Resources/deployments','Phase6-GridEnvMgrSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('gridnode_vm_name'), copyIndex(1))]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./agent_startup_gridnodes.sh 2>&1 | tee /var/log/sas/install/agent_startup_gridnodes.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('agent_startup_gridnodes_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('mgt_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mgt_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_lustre_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mgt_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('mgt_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('lustrevm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('mgt_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('LustreVmSize')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('mgt_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('lustre_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('mgt_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('lustre_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('mgt_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('mgt_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-MgtHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('mgt_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mgt_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./lustre_pre_install.sh 2>&1 | tee /var/log/sas/install/lustre_pre_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('lustre_pre_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-MgtWait",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('mgt_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-MgtHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments','Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('ansible_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./mgt_wait.sh 2>&1 | tee /var/log/sas/install/mgt_wait.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('mgt_wait_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase3-MgtInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('mgt_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-MgtWait')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mgt_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./mgt_pkg_install.sh 2>&1 | tee /var/log/sas/install/mgt_pkg_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('mgt_pkg_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('mdt_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mdt_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_lustre_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mdt_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('mdt_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('lustrevm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('mdt_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('LustreVmSize')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('mdt_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('lustre_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('mdt_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('lustre_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('mdt_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('mdt_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-MdtHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('mdt_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mdt_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./lustre_pre_install.sh',' ',variables('mgt_vm_name'),' ','2>&1 | tee /var/log/sas/install/lustre_pre_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('lustre_pre_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-mdtInstall",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',variables('mdt_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments','Phase3-MgtInstall')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('mdt_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./mdt_pkg_install.sh 2>&1 | tee /var/log/sas/install/mdt_pkg_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('mdt_pkg_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[concat(parameters('SAS Application Name'),'_',variables('oss_vm_name'),copyIndex(1),'_nic_',variables('resourceGroupUniqueString'))]",
            "copy": {
                "name": "sasnodeNICcopy",
                "count": "[parameters('Number of Lustre OSS Nodes')]"
            },
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('oss_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_lustre_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('oss_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[concat(variables('oss_vm_name'), copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of Lustre OSS Nodes')]"
            },
            "location": "[parameters('Location')]",
            "tags": "[variables('lustrevm_tags')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('SAS Application Name'),'_',variables('oss_vm_name'),copyIndex(1),'_nic_',variables('resourceGroupUniqueString')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('Lustre OSS Node VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('oss_vm_name'),copyIndex(1),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('lustre_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk1')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 0,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk2')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 1,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk3')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 2,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk4')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 3,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk5')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 4,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk6')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 5,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk7')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 6,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk8')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 7,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk9')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 8,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        },
                        {
                            "name": "[concat(variables('oss_vm_name'), copyIndex(1),'-datadisk10')]",
                            "diskSizeGB": "[variables('disk_size_10')]",
                            "lun": 9,
                            "createOption": "Empty",
                            "managedDisk": {
                                "storageAccountType": "Premium_LRS"
                            }
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[concat(variables('oss_vm_name'), copyIndex(1))]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('SAS Application Name'),'_',variables('oss_vm_name'),copyIndex(1),'_nic_',variables('resourceGroupUniqueString')))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase1-OSSHostSetup', copyIndex(1))]",
            "copy": {
                "name": "sasnodecopy",
                "count": "[parameters('Number of Lustre OSS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('oss_vm_name'), copyIndex(1)))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('oss_vm_name'), copyIndex(1))]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./lustre_pre_install.sh',' ',variables('mgt_vm_name'),' ',copyIndex(1),' ','2>&1 | tee /var/log/sas/install/lustre_pre_install.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('lustre_pre_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase2-OSS-Install', copyIndex(1))]",
            "copy": {
                "name": "ossnodecopy",
                "count": "[parameters('Number of Lustre OSS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',concat(variables('oss_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Resources/deployments','Phase3-MgtInstall')]",
                "[resourceId('Microsoft.Resources/deployments','Phase2-mdtInstall')]",
                "[resourceId('Microsoft.Resources/deployments',concat('Phase1-OSSHostSetup', copyIndex(1)))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('oss_vm_name'), copyIndex(1))]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./oss_node_install.sh 2>&1 | tee /var/log/sas/install/pre-req.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('oss_node_install_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('microservices_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('microservices_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_viya_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('microservices_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('microservices_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sasviyavm_tags')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('microservices_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('Viya Microservices VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('microservices_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('microservices_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        },
                        {
                            "name": "[concat(variables('microservices_vm_name'),'-sasbackup')]",
                            "diskSizeGB": "[variables('sas_viya_backup_size')]",
                            "lun": 1,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('microservices_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('microservices_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "MicroServicesRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('microservices_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid('microservices',resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('microservices_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "MicroServicesAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('microservices_vm_name'))]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]",
                "sasgridnodecopy"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('microservices_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-MicroServicesHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('microservices_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'MicroServicesAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('microservices_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./viya_prereq.sh',' ',parameters('Storage Account Name'),' ',parameters('File Share Name'),' ',parameters('Viyarepo Folder'),' ',parameters('SAS Application Name'),' ',variables('domain_name'),' ',variables('ansible_vm_name'),' ',variables('microservices_vm_name'),' ',variables('cascontroller_vm_name'),' ',variables('spre_vm_name'),' ',variables('casworker_vm_name'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',parameters('Number Of Viya CAS Nodes'),' ',parameters('_artifactsLocation'),' ',variables('key_vault_secretname_stgacc'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_startup_script_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-MicroServicesViyaARK",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-MicroServicesHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('microservices_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viya_ark.sh 2>&1 | tee /var/log/sas/install/runPhase2_viyaark.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_ark_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('spre_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('spre_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_viya_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('spre_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('spre_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sasviyavm_tags')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('spre_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('Viya SPRE VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('spre_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('spre_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        },
                        {
                            "name": "[concat(variables('spre_vm_name'),'-sasbackup')]",
                            "diskSizeGB": 100,
                            "lun": 1,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('spre_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "customData": "[base64(variables('custom_data_sas'))]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('spre_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "SpreRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('spre_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid('spre',resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('spre_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "SpreAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('spre_vm_name'))]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]",
                "[resourceId('Microsoft.Resources/deployments','MicroServicesAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('spre_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-SpreHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',  variables('spre_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'SpreAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('spre_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./viya_prereq.sh',' ',parameters('Storage Account Name'),' ',parameters('File Share Name'),' ',parameters('Viyarepo Folder'),' ',parameters('SAS Application Name'),' ',variables('domain_name'),' ',variables('ansible_vm_name'),' ',variables('microservices_vm_name'),' ',variables('cascontroller_vm_name'),' ',variables('spre_vm_name'),' ',variables('casworker_vm_name'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',parameters('Number Of Viya CAS Nodes'),' ',parameters('_artifactsLocation'),' ',variables('key_vault_secretname_stgacc'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_startup_script_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-SpreViyaARK",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments','Phase1-SpreHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('spre_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viya_ark.sh 2>&1 | tee /var/log/sas/install/runPhase2_viyaark.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_ark_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('cascontroller_nw_interface')]",
            "location": "[parameters('Location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('cascontroller_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_viya_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('cascontroller_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[variables('Cascontroller_vm_name')]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sasviyavm_tags')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('cascontroller_nw_interface'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('Viya CAS Controller VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('cascontroller_vm_name'),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('cascontroller_vm_name'),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        },
                        {
                            "name": "[concat(variables('cascontroller_vm_name'),'-sasbackup')]",
                            "diskSizeGB": "[variables('sas_viya_backup_size')]",
                            "lun": 1,
                            "createOption": "Empty"
                        },
                        {
                            "name": "[concat(variables('cascontroller_vm_name'),'-sasdata')]",
                            "diskSizeGB": "[parameters('SAS Viya Data Storage')]",
                            "lun": 2,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('Cascontroller_vm_name')]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "customData": "[base64(variables('custom_data_cas'))]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('cascontroller_nw_interface'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(variables('diagnostic_storagegroup_name')).primaryEndpoints.blob]"
                    }
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            },
            "resources": []
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "CAScontrollerRoleAssignment",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('Cascontroller_vm_name'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid('cascontroller',resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('Cascontroller_vm_name')),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "CAScontrollerAccessPolicy",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('Cascontroller_vm_name'))]",
                "[resourceID('Microsoft.Resources/deployments','MicroServicesAccessPolicy')]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]",
                "[resourceId('Microsoft.Resources/deployments','SpreAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',variables('Cascontroller_vm_name')),'2019-12-01', 'Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase1-CASControllerHostSetup",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines',  variables('Cascontroller_vm_name'))]",
                "[resourceId('Microsoft.Resources/deployments', 'CAScontrollerAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('Cascontroller_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./viya_prereq.sh',' ',parameters('Storage Account Name'),' ',parameters('File Share Name'),' ',parameters('Viyarepo Folder'),' ',parameters('SAS Application Name'),' ',variables('domain_name'),' ',variables('ansible_vm_name'),' ',variables('microservices_vm_name'),' ',variables('cascontroller_vm_name'),' ',variables('spre_vm_name'),' ',variables('casworker_vm_name'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',parameters('Number Of Viya CAS Nodes'),' ',parameters('_artifactsLocation'),' ',variables('key_vault_secretname_stgacc'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_startup_script_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Phase2-CASControllerViyaARK",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-CASControllerHostSetup')]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[variables('Cascontroller_vm_name')]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viya_ark.sh 2>&1 | tee /var/log/sas/install/runPhase2_viyaark.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_ark_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[concat(parameters('SAS Application Name'),'_',variables('casworker_vm_name'),copyIndex(),'_nic_',variables('resourceGroupUniqueString'))]",
            "location": "[parameters('Location')]",
            "copy": {
                "name": "casworkernicLoop",
                "count": "[parameters('Number Of Viya CAS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('casworker_nw_sg'))]",
                "[resourceId('Microsoft.Network/virtualNetworks',variables('vnet_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnet_name'), variables('vnet_viya_pvt_subnt'))]"
                            },
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('casworker_nw_sg'))]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[concat(variables('casworker_vm_name'), copyIndex())]",
            "location": "[parameters('Location')]",
            "tags": "[variables('sasviyavm_tags')]",
            "copy": {
                "name": "casworkervmLoop",
                "count": "[parameters('Number Of Viya CAS Nodes')]"
            },
            "dependsOn": [
                "casworkernicLoop",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('diagnostic_storagegroup_name'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('Viya CAS Worker VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.7",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat(variables('casworker_vm_name'), copyIndex(),'-osdisk')]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "diskSizeGB": "[variables('sas_osdisk_size')]"
                    },
                    "dataDisks": [
                        {
                            "name": "[concat(variables('casworker_vm_name'), copyIndex(),'-opt-sas')]",
                            "diskSizeGB": "[variables('sas_opt_sas_disk_size')]",
                            "lun": 0,
                            "createOption": "Empty"
                        },
                        {
                            "name": "[concat(variables('casworker_vm_name'), copyIndex(),'-sasbackup')]",
                            "diskSizeGB": "[variables('sas_viya_backup_size')]",
                            "lun": 1,
                            "createOption": "Empty"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[concat(variables('casworker_vm_name'), copyIndex())]",
                    "adminUsername": "[variables('PrimaryUserName')]",
                    "customData": "[base64(variables('custom_data_cas'))]",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "[concat('/home/', variables('PrimaryUserName'), '/.ssh/authorized_keys')]",
                                    "keyData": "[parameters('SSHPublicKey')]"
                                }
                            ]
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('SAS Application Name'),'_',variables('casworker_vm_name'),copyIndex(),'_nic_',variables('resourceGroupUniqueString')))]"
                        }
                    ]
                },
                "proximityPlacementGroup": {
                    "id": "[resourceId('Microsoft.Compute/proximityPlacementGroups',variables('ppg_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat(variables('casworker_vm_name'), copyIndex(),'roleassignment')]",
            "copy": {
                "name": "casworkerrolecopy",
                "count": "[parameters('Number Of Viya CAS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('casworker_vm_name'), copyIndex()))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('role_assignment_template')]"
                },
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[guid(concat(variables('casworker_vm_name'), copyIndex()),resourceGroup().id)]"
                    },
                    "roleDefinitionID": {
                        "value": "[variables('reader_role')]"
                    },
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',concat(variables('casworker_vm_name'), copyIndex())),'2019-07-01','Full').identity.principalId]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat(variables('casworker_vm_name'), copyIndex(),'accesspolicy')]",
            "copy": {
                "mode": "serial",
                "batchSize": 1,
                "name": "casworkerpolicycopy",
                "count": "[parameters('Number Of Viya CAS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('casworker_vm_name'), copyIndex()))]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('key_vault_name'))]",
                "[resourceId('Microsoft.Resources/deployments','CAScontrollerAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('access_policy_template')]"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[variables('key_vault_name')]"
                    },
                    "tenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "objectId": {
                        "value": "[reference(resourceId('Microsoft.Compute/virtualMachines',concat(variables('casworker_vm_name'), copyIndex())),'2019-07-01','Full').identity.principalId]"
                    },
                    "secretsPermissions": {
                        "value": "[variables('secretsPermissions')]"
                    },
                    "keysPermissions": {
                        "value": "[variables('keysPermissions')]"
                    },
                    "certificatesPermissions": {
                        "value": "[variables('certificatesPermissions')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase1-',variables('casworker_vm_name'), copyIndex(),'Hostsetup')]",
            "copy": {
                "name": "casworkerextensioncopy",
                "count": "[parameters('Number Of Viya CAS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('casworker_vm_name'), copyIndex()))]",
                "[resourceId('Microsoft.Resources/deployments', concat(variables('casworker_vm_name'), copyIndex(),'accesspolicy') )]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('casworker_vm_name'), copyIndex())]"
                    },
                    "commandToExecute": {
                        "value": "[concat('mkdir -p /var/log/sas/install && set -o pipefail; ./viya_prereq.sh',' ',parameters('Storage Account Name'),' ',parameters('File Share Name'),' ',parameters('Viyarepo Folder'),' ',parameters('SAS Application Name'),' ',variables('domain_name'),' ',variables('ansible_vm_name'),' ',variables('microservices_vm_name'),' ',variables('cascontroller_vm_name'),' ',variables('spre_vm_name'),' ',variables('casworker_vm_name'),' ',variables('key_vault_secretname_sasinst'),' ',variables('key_vault_secretname_sasext'),' ',variables('key_vault_name'),' ',variables('key_vault_secretname_pvtkey'),' ',variables('key_vault_secretname_pubkey'),' ',parameters('Number Of Viya CAS Nodes'),' ',parameters('_artifactsLocation'),' ',variables('key_vault_secretname_stgacc'),' ','2>&1 | tee /var/log/sas/install/runPhase1_HostSetup.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_startup_script_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Phase2-',variables('casworker_vm_name'), copyIndex(),'ViyaARK')]",
            "copy": {
                "name": "casworkerviyaarkcopy",
                "count": "[parameters('Number Of Viya CAS Nodes')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', concat('Phase1-',variables('casworker_vm_name'), copyIndex(),'Hostsetup'))]",
                "[resourceId('Microsoft.Resources/deployments', 'Phase1-AnsibleHostSetup')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('linux_extension_template')]"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('Location')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('casworker_vm_name'), copyIndex())]"
                    },
                    "commandToExecute": {
                        "value": "[concat('set -o pipefail;','./viya_ark.sh 2>&1 | tee /var/log/sas/install/runPhase2_viyaark.log')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('viya_ark_sh')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[variables('_artifactsLocationSasToken')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "Ansible-JumpHost Server IP": {
            "value": "[concat(reference(resourceId('Microsoft.Compute/virtualMachines',variables('ansible_vm_name'))).osProfile.adminUsername,'@',reference(resourceId('Microsoft.Network/publicIPAddresses',variables('ansible_pub_nw_interface'))).IpAddress)]",
            "type": "string"
        },
        "SAS RDP Server IP": {
            "value": "[reference(resourceId('Microsoft.Network/networkInterfaces',variables('rdp_nw_interface'))).ipConfigurations[0].properties.privateIPAddress]",
            "type": "string"
        },
        "SAS9 Logon": {
            "value": "[concat('https://',parameters('SAS Application Name'),variables('mid_vm_name'),'.',variables('domain_name'),':8343/SASLogon')]",
            "type": "string"
        },
        "SASStudio MidTier": {
            "value": "[concat('https://',parameters('SAS Application Name'),variables('mid_vm_name'),'.',variables('domain_name'),':8343/SASStudio')]",
            "type": "string"
        },
		"SAS9 Grid Manager": {
            "value": "[concat('https://',parameters('SAS Application Name'),variables('mid_vm_name'),'.',variables('domain_name'),':8343/SASGridManager')]",
            "type": "string"
        },
        "SAS9 Install User": {
            "value": "sasinst",
            "type": "string"
        },
        "Viya SASDrive": {
            "value": "[concat('https://',parameters('SAS Application Name'),variables('microservices_vm_name'),'.',variables('domain_name'),'/SASDrive')]",
            "type": "string"
        },
        "Viya SASStudio": {
            "value": "[concat('https://',parameters('SAS Application Name'),variables('microservices_vm_name'),'.',variables('domain_name'),'/SASStudio')]",
            "type": "string"
        },
        "Viya SAS Admin Password Reset URL": {
            "type": "String",
            "value": "[concat('https://',parameters('SAS Application Name'),variables('microservices_vm_name'),'.',variables('domain_name'),'/SASLogon/reset_password?code=',json(split(reference('Phase6-ViyaPostInstall').outputs.instanceView.value.statuses[0].message, '#SASBOOT#')[1]).SAS_BOOT)]"
        }
    }
}
